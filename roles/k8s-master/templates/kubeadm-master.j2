apiVersion: kubeadm.k8s.io/v1alpha2
kind: MasterConfiguration
apiServerCertSANs:
- "{{ load_balancer_dns }}"
apiServerExtraArgs:
    etcd-servers: "https://127.0.0.1:2379,https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2379,https://{{ hostvars[groups['etcd'][1]]['ip'] }}:2379,https://{{ hostvars[groups['etcd'][2]]['ip'] }}:2379"
api:
    controlPlaneEndpoint: "{{ load_balancer_dns }}:{{ load_balancer_port }}"
etcd:
  local:
    extraArgs:
    {% if  ansible_hostname == hostvars[groups['etcd'][0]]['inventory_hostname'] %}

      listen-client-urls: "https://0.0.0.0:2379"
      advertise-client-urls: "https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2379"
      listen-peer-urls: "https://0.0.0.0:2380"
      initial-advertise-peer-urls: "https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2380"
      initial-cluster: "{{ hostvars[groups['etcd'][0]]['inventory_hostname'] }}=https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2380"
      name: {{ inventory_hostname }}
      initial-cluster-state: new

    {% elif ansible_hostname == hostvars[groups['etcd'][1]]['inventory_hostname'] %}

      listen-client-urls: "https://0.0.0.0:2379"
      advertise-client-urls: "https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2379"
      listen-peer-urls: "https://0.0.0.0:2380"
      initial-advertise-peer-urls: "https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2380"
      initial-cluster: "{{ hostvars[groups['etcd'][0]]['inventory_hostname'] }}=https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2380,{{ hostvars[groups['etcd'][1]]['inventory_hostname'] }}=https://{{ hostvars[groups['etcd'][1]]['ip'] }}:2380"
      name: {{ inventory_hostname }}
      initial-cluster-state: existing
    {% elif ansible_hostname == hostvars[groups['etcd'][2]]['inventory_hostname'] %}

      listen-client-urls: "https://0.0.0.0:2379"
      advertise-client-urls: "https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2379"
      listen-peer-urls: "https://0.0.0.0:2380"
      initial-advertise-peer-urls: "https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2380"
      initial-cluster: "{{ hostvars[groups['etcd'][0]]['inventory_hostname'] }}=https://{{ hostvars[groups['etcd'][0]]['ip'] }}:2380,{{ hostvars[groups['etcd'][1]]['inventory_hostname'] }}=https://{{ hostvars[groups['etcd'][1]]['ip'] }}:2380,{{ hostvars[groups['etcd'][2]]['inventory_hostname'] }}=https://{{ hostvars[groups['etcd'][2]]['ip'] }}:2380"
      name: {{ inventory_hostname }}
      initial-cluster-state: existing
    {% endif %}

    serverCertSANs:
      - {{ inventory_hostname }}
      - {{ ip | default(ansible_default_ipv4.address) }}
    peerCertSANs:
      - {{ inventory_hostname }}
      - {{ ip | default(ansible_default_ipv4.address) }}
networking:
  podSubnet: 192.168.0.0/16
kubernetesVersion: v1.11.2
